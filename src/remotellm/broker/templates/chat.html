{% extends "base.html" %}

{% block title %}Chat - RemoteLLM{% endblock %}

{% block content %}
<div class="card">
    <h2>Chat</h2>
    <p style="margin-bottom: 15px; color: #7f8c8d;">Send a message to any available model.</p>

    <div style="margin-bottom: 15px;">
        <label for="model-select" style="display: block; margin-bottom: 5px; font-weight: 500;">Model:</label>
        <select id="model-select" style="width: 100%; max-width: 400px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;">
            {% for model in models %}
            {% set connector_id = model_connectors.get(model, '') %}
            {% set is_mock = connector_id.startswith('mock-') %}
            <option value="{{ model }}" style="{% if is_mock %}color: #999; font-style: italic;{% else %}font-weight: bold;{% endif %}">{{ model }}{% if is_mock %} (test){% endif %}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div class="card" style="min-height: 400px; display: flex; flex-direction: column;">
    <h2>Conversation</h2>
    <div id="chat-messages" style="flex: 1; overflow-y: auto; margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; min-height: 300px;">
        <div style="color: #7f8c8d; text-align: center; padding: 20px;">
            Select a model and send a message to start chatting.
        </div>
    </div>

    <div style="display: flex; gap: 10px;">
        <textarea id="user-input" placeholder="Type your message..."
            style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; resize: none; min-height: 60px;"
            onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
        <button onclick="sendMessage()" class="btn btn-primary" id="send-btn" style="align-self: flex-end;">Send</button>
    </div>
</div>

<style>
    .message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 8px;
        max-width: 80%;
    }
    .message-user {
        background: #3498db;
        color: white;
        margin-left: auto;
    }
    .message-assistant {
        background: white;
        border: 1px solid #ddd;
    }
    .message-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .message-label {
        font-size: 0.75rem;
        opacity: 0.7;
        margin-bottom: 5px;
    }
    .message-content {
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .typing-indicator {
        display: inline-block;
        padding: 10px 15px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
    }
    .typing-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #7f8c8d;
        border-radius: 50%;
        margin-right: 4px;
        animation: typing 1s infinite;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 1; }
    }
    .streaming-cursor::after {
        content: '\u258C';
        animation: blink 0.7s infinite;
        color: #3498db;
    }
    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0; }
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    const apiKey = "{{ api_key }}";
    const messages = [];

    function addMessage(role, content, isError = false) {
        const chatMessages = document.getElementById('chat-messages');

        // Remove placeholder if present
        if (messages.length === 0) {
            chatMessages.innerHTML = '';
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${isError ? 'error' : role}`;

        const label = document.createElement('div');
        label.className = 'message-label';
        label.textContent = role === 'user' ? 'You' : (isError ? 'Error' : 'Assistant');

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = content;

        messageDiv.appendChild(label);
        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        return contentDiv;
    }

    function createStreamingMessage() {
        const chatMessages = document.getElementById('chat-messages');

        // Remove placeholder if present
        if (messages.length === 0) {
            chatMessages.innerHTML = '';
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message message-assistant';
        messageDiv.id = 'streaming-message';

        const label = document.createElement('div');
        label.className = 'message-label';
        label.textContent = 'Assistant';

        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content streaming-cursor';
        contentDiv.id = 'streaming-content';

        messageDiv.appendChild(label);
        messageDiv.appendChild(contentDiv);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        return contentDiv;
    }

    function updateStreamingMessage(content) {
        const contentDiv = document.getElementById('streaming-content');
        if (contentDiv) {
            contentDiv.textContent = content;
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    function finalizeStreamingMessage() {
        const messageDiv = document.getElementById('streaming-message');
        const contentDiv = document.getElementById('streaming-content');
        if (messageDiv) messageDiv.removeAttribute('id');
        if (contentDiv) {
            contentDiv.classList.remove('streaming-cursor');
            contentDiv.removeAttribute('id');
        }
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const modelSelect = document.getElementById('model-select');
        const userMessage = input.value.trim();

        if (!userMessage) return;

        // Add user message
        messages.push({ role: 'user', content: userMessage });
        addMessage('user', userMessage);
        input.value = '';

        // Disable input while waiting
        sendBtn.disabled = true;
        input.disabled = true;

        // Create streaming message placeholder
        createStreamingMessage();
        let fullContent = '';

        try {
            const response = await fetch('/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: modelSelect.value,
                    messages: messages,
                    stream: true
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API error: ${response.status} - ${errorText}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();

                for (const line of lines) {
                    const trimmed = line.trim();
                    if (!trimmed || !trimmed.startsWith('data: ')) continue;

                    const data = trimmed.slice(6);
                    if (data === '[DONE]') continue;

                    try {
                        const parsed = JSON.parse(data);
                        const delta = parsed.choices?.[0]?.delta?.content;
                        if (delta) {
                            fullContent += delta;
                            updateStreamingMessage(fullContent);
                        }
                    } catch (e) {
                        // Skip malformed JSON
                    }
                }
            }

            // Process remaining buffer
            if (buffer.trim()) {
                const trimmed = buffer.trim();
                if (trimmed.startsWith('data: ') && trimmed.slice(6) !== '[DONE]') {
                    try {
                        const parsed = JSON.parse(trimmed.slice(6));
                        const delta = parsed.choices?.[0]?.delta?.content;
                        if (delta) {
                            fullContent += delta;
                            updateStreamingMessage(fullContent);
                        }
                    } catch (e) {}
                }
            }

            finalizeStreamingMessage();
            messages.push({ role: 'assistant', content: fullContent });

        } catch (error) {
            finalizeStreamingMessage();
            const contentDiv = document.querySelector('#streaming-message .message-content, .message:last-child .message-content');
            if (contentDiv && !fullContent) {
                contentDiv.parentElement.className = 'message message-error';
                contentDiv.textContent = error.message;
            } else {
                addMessage('assistant', error.message, true);
            }
        } finally {
            sendBtn.disabled = false;
            input.disabled = false;
            input.focus();
        }
    }
</script>
{% endblock %}
